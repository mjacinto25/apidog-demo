name: Verify the field worker jobs - Test

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APIDOG_ACCESS_TOKEN: ${{ secrets.APIDOG_ACCESS_TOKEN }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
      
    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js environment
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Install Apidog CLI
      run: npm install -g apidog-cli

    - name: Running Test Scenario
      run: apidog run --access-token $APIDOG_ACCESS_TOKEN -t 1542843 -e 5154254 -n 1 -r html,cli

    - name: Create Jira Ticket if Tests Fail
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          const jiraUrl = `${process.env.JIRA_BASE_URL}/rest/api/2/issue`;

           const description =
                "Test failure detected in GitHub Actions.\n" +
                "Run Number: " + process.env.GITHUB_RUN_NUMBER + "\n" +
                "Run ID: " + process.env.GITHUB_RUN_ID + "\n" +
                "Commit: " + process.env.GITHUB_SHA + "\n" +
                "Branch: " + process.env.GITHUB_REF_NAME;
  
          const payload = {
            fields: {
              project: { key: process.env.JIRA_PROJECT_KEY },
              summary: "[Automated Test Failure] - Workflow: " + process.env.GITHUB_WORKFLOW,
              description: description,
              issuetype: { name: "Bug" }
            }
          };
  
          const response = await fetch(jiraUrl, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': 'Basic ' + Buffer.from(`${process.env.JIRA_EMAIL}:${process.env.JIRA_API_TOKEN}`).toString('base64')
            },
            body: JSON.stringify(payload)
          });
  
          if (!response.ok) {
            throw new Error(`Failed to create Jira ticket: ${response.status} ${response.statusText}`);
          }
          console.log('Jira ticket created successfully');
