name: Verify the field worker jobs - update

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      APIDOG_ACCESS_TOKEN: ${{ secrets.APIDOG_ACCESS_TOKEN }}
      JIRA_EMAIL: ${{ secrets.JIRA_EMAIL }}
      JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
      JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
      JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
      GITHUB_WORKFLOW_NAME: ${{ github.workflow }}
      GITHUB_RUN_ID: ${{ github.run_id }}
      GITHUB_SHA: ${{ github.sha }}
      GITHUB_BRANCH: ${{ github.ref }}

    steps:
    - uses: actions/checkout@v3

    - name: Setup Node.js environment
      uses: actions/setup-node@v2
      with:
        node-version: '18'

    - name: Install Apidog CLI
      run: npm install -g apidog-cli

    - name: Running Test Scenario
      id: apidog
      run: |
        # Allow script to continue even if tests fail
        set +e
        apidog run --access-token "$APIDOG_ACCESS_TOKEN" -t 1542843 -e 5154254 -n 1 -r html,cli
        EXIT_CODE=$?
        echo "APIDOG_EXIT_CODE=$EXIT_CODE" >> $GITHUB_ENV
        exit 0

    - name: Create Jira Ticket if Tests Fail
      if: env.APIDOG_EXIT_CODE != '0'
      uses: actions/github-script@v6
      with:
        script: |
          const axios = require('axios');

          const jiraUrl = process.env.JIRA_BASE_URL + "/rest/api/2/issue";

          const description =
            "Test failure detected in GitHub Actions.\n" +
            "Workflow: " + process.env.GITHUB_WORKFLOW_NAME + "\n" +
            "Run ID: " + process.env.GITHUB_RUN_ID + "\n" +
            "Commit: " + process.env.GITHUB_SHA + "\n" +
            "Branch: " + process.env.GITHUB_BRANCH;

          const payload = {
            fields: {
              project: { key: process.env.JIRA_PROJECT_KEY },
              summary: "Automated Test Failure in GitHub Actions",
              description: description,
              issuetype: { name: "Bug" }
            }
          };

          await axios.post(jiraUrl, payload, {
            headers: { "Content-Type": "application/json" },
            auth: {
              username: process.env.JIRA_EMAIL,
              password: process.env.JIRA_API_TOKEN
            }
          });
